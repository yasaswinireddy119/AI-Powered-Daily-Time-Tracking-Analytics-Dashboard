<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TimeWise — Demo + Firebase Ready</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root{--bg:#FBFBFD;--card:#e9eeb2;--muted:#667085;--accent:#ebf310;--pastel1:#EBDFF8;--radius:12px}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Arial;background:linear-gradient(180deg,var(--pastel1),#eff7c1);display:flex;justify-content:center;padding:20px}
    .wrap{width:100%;max-width:980px;background:var(--bg);border-radius:14px;padding:16px;box-shadow:0 10px 24px rgba(16,24,40,0.08)}
    header{display:flex;justify-content:space-between;align-items:center}
    h1{margin:0;font-size:20px}
    .controls{display:flex;gap:8px;align-items:center}
    button{cursor:pointer;padding:8px 12px;border-radius:8px;border:0}
    .primary{background:var(--accent);color:#3b2f2f}
    .ghost{background:#e3df12;border:1px solid #eddd04}
    .grid{display:grid;grid-template-columns:300px 1fr;gap:12px;margin-top:12px}
    .panel{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 16px rgba(15,23,42,0.04)}
    label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted)}
    input,select{width:100%;padding:8px;border-radius:8px;border:1px solid #c3e032;margin-bottom:10px}
    .activity{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;border:1px dashed #f2f2f2;margin-bottom:8px;background:#fff}
    .small{font-size:13px;color:var(--muted)}
    .no-data{text-align:center;padding:20px;border-radius:10px;border:1px dashed #dfdfea}
    @media(max-width:800px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>TimeWise — Demo + Firebase Ready</h1>
        <div class="small">Add activities (minutes). Total per day ≤ 1440. Demo mode works without Firebase.</div>
      </div>
      <div class="controls" id="authArea">
        <button id="signInBtn" class="primary">Sign In (Demo)</button>
        <button id="seedBtn" class="ghost">Seed Demo</button>
      </div>
    </header>

    <div class="grid">
      <!-- Sidebar: add activity -->
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Add Activity</strong>
          <div class="small" id="remaining">Remaining: 1440 min</div>
        </div>

        <label for="date">Date</label>
        <input id="date" type="date" />

        <label for="title">Title</label>
        <input id="title" placeholder="e.g. Study" />

        <label for="category">Category</label>
        <select id="category">
          <option>Work</option><option>Study</option><option>Sleep</option><option>Exercise</option><option>Entertainment</option><option>Other</option>
        </select>

        <label for="minutes">Minutes</label>
        <input id="minutes" type="number" min="1" placeholder="e.g. 60" />

        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="addBtn" class="primary">Add</button>
          <button id="clearBtn" class="ghost">Clear</button>
        </div>

        <hr style="margin:12px 0">
        <div class="small">Analyse only enabled when total for the date = 1440 minutes.</div>
      </div>

      <!-- Main: list & analytics -->
      <div>
        <div class="panel" style="margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Activities for <span id="displayDate">—</span></strong></div>
            <div style="display:flex;gap:8px;align-items:center">
              <div class="small">Total: <span id="total">0</span> min</div>
              <button id="analyseBtn" class="primary" disabled>Analyse</button>
            </div>
          </div>

          <div id="list" style="margin-top:12px"></div>

          <div id="noData" class="no-data" style="display:none;margin-top:12px">
            <div style="font-size:18px">No data available</div>
            <div class="small">Start logging your day to view analytics.</div>
          </div>
        </div>

        <div class="panel" id="analyticsPanel" style="display:none">
          <strong>Analytics</strong>
          <div class="small">Time spent by category</div>
          <div style="max-width:560px;margin-top:12px">
            <canvas id="chart"></canvas>
          </div>
          <div style="text-align:right;margin-top:8px">
            <button id="closeChart" class="ghost">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script type="module">
/*
  TimeWise — Demo + Firebase-ready single file.
  Behavior:
   - If you paste real Firebase config below, app will use Firebase Auth + Firestore.
   - If firebaseConfig left as placeholder, app uses demo mode (localStorage) so ALL buttons work now.
*/

// ========== PASTE FIREBASE CONFIG HERE TO ENABLE REAL FIREBASE ==========
// Create a Firebase web app in console.firebase.google.com and paste its config below.
// For demo/testing you may leave this as-is and the app will run in localStorage demo mode.
const firebaseConfig = {
  apiKey: "PASTE_OR_LEAVE",
  authDomain: "PASTE_OR_LEAVE",
  projectId: "PASTE_OR_LEAVE",
  storageBucket: "PASTE_OR_LEAVE",
  messagingSenderId: "PASTE_OR_LEAVE",
  appId: "PASTE_OR_LEAVE"
};
// =======================================================================

// DOM
const dateInput = document.getElementById('date');
const titleInput = document.getElementById('title');
const categoryInput = document.getElementById('category');
const minutesInput = document.getElementById('minutes');
const addBtn = document.getElementById('addBtn');
const clearBtn = document.getElementById('clearBtn');
const listEl = document.getElementById('list');
const totalEl = document.getElementById('total');
const remainingEl = document.getElementById('remaining');
const displayDateEl = document.getElementById('displayDate');
const analyseBtn = document.getElementById('analyseBtn');
const analyticsPanel = document.getElementById('analyticsPanel');
const chartCanvas = document.getElementById('chart');
const closeChart = document.getElementById('closeChart');
const signInBtn = document.getElementById('signInBtn');
const seedBtn = document.getElementById('seedBtn');
const noDataEl = document.getElementById('noData');

let chartInstance = null;
let currentUser = null; // in demo mode: a fake user id
let currentDate = null;
let activities = []; // array of {id,title,category,minutes}

// ========== simple util ==========
function uid(){ return 'u_'+Math.random().toString(36).slice(2,9); }
function todayISO(){ return new Date().toISOString().slice(0,10); }
function genId(){ return 'a_'+Math.random().toString(36).slice(2,9); }
function show(msg){ alert(msg); }

// ========== storage layer abstraction ==========
const DEMO_PREFIX = 'timewise_demo_v1';

// check firebase config validity (very basic)
function firebaseConfigured(){
  return firebaseConfig && firebaseConfig.apiKey && !firebaseConfig.apiKey.includes('PASTE');
}

/* If Firebase configured, we will initialize Firebase and use Firestore & Auth.
   If not configured, we will use localStorage demo mode (all CRUD locally).
*/
let usingFirebase = false;
let firebaseExports = null;

async function initBackend(){
  if(firebaseConfigured()){
    try{
      // dynamic import firebase modules from CDN (modular v9)
      const { initializeApp } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js');
      const { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js');
      const { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc, onSnapshot } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js');

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      firebaseExports = { auth, db, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, collection, addDoc, getDocs, doc, deleteDoc, updateDoc, onSnapshot };
      usingFirebase = true;
      console.log('Firebase initialized — using Firestore mode.');
      setupFirebaseAuthListener();
    }catch(e){
      console.error('Firebase init failed — falling back to demo mode', e);
      usingFirebase = false;
      setupDemoAuth();
    }
  } else {
    usingFirebase = false;
    setupDemoAuth();
  }
}

// ========== Demo Auth & storage functions ==========
function setupDemoAuth(){
  // create a demo user automatically
  if(!currentUser){
    currentUser = { uid: 'demo_user', email: 'demo@example.com', displayName: 'Demo User' };
    signInBtn.textContent = 'Signed in (Demo)';
    signInBtn.onclick = ()=> show('You are signed in as demo user.');
  }
}
// storage keys: per user+date
function demoStorageKey(userId, date){
  return `${DEMO_PREFIX}:${userId}:${date}`;
}
function demoLoadActivities(userId, date){
  const key = demoStorageKey(userId,date);
  const raw = localStorage.getItem(key);
  return raw ? JSON.parse(raw) : [];
}
function demoSaveActivities(userId, date, arr){
  const key = demoStorageKey(userId,date);
  localStorage.setItem(key, JSON.stringify(arr));
}

// ========== Firebase auth & storage functions ==========
function setupFirebaseAuthListener(){
  const { auth, onAuthStateChanged } = firebaseExports;
  onAuthStateChanged(auth, user => {
    if(user){
      currentUser = user;
      signInBtn.textContent = 'Sign Out';
      signInBtn.onclick = async () => {
        try { await firebaseExports.signOut(auth); } catch(e){ console.error(e) }
      };
      // start listening for changes when user logged in
      startListeningFirestore();
    } else {
      currentUser = null;
      signInBtn.textContent = 'Sign In (Google)';
      signInBtn.onclick = firebaseSignIn;
      // fallback to demo mode if user signs out
    }
  });
}

async function firebaseSignIn(){
  try{
    const { auth, signInWithPopup, GoogleAuthProvider } = firebaseExports;
    const provider = new GoogleAuthProvider();
    await signInWithPopup(auth, provider);
  }catch(e){
    console.error('Firebase sign-in error', e);
    show('Sign in failed. Check console.');
  }
}

// firestore helpers
async function firestoreLoadActivities(userId, date){
  // collection path: users/{uid}/days/{date}/activities
  const { db, collection, getDocs } = firebaseExports;
  const coll = collection(db, `users/${userId}/days/${date}/activities`);
  const snap = await getDocs(coll);
  const res = [];
  snap.forEach(d => res.push({ id: d.id, ...d.data() }));
  return res;
}
async function firestoreAddActivity(userId, date, activity){
  const { db, collection, addDoc } = firebaseExports;
  const coll = collection(db, `users/${userId}/days/${date}/activities`);
  const docRef = await addDoc(coll, activity);
  return { id: docRef.id, ...activity };
}
async function firestoreDeleteActivity(userId, date, id){
  const { db, doc, deleteDoc } = firebaseExports;
  const docRef = doc(db, `users/${userId}/days/${date}/activities/${id}`);
  await deleteDoc(docRef);
}
async function firestoreUpdateActivity(userId, date, id, updated){
  const { db, doc, updateDoc } = firebaseExports;
  const docRef = doc(db, `users/${userId}/days/${date}/activities/${id}`);
  await updateDoc(docRef, updated);
}
let firestoreUnsub = null;
function startListeningFirestore(){
  if(!usingFirebase || !currentUser) return;
  // attach snapshot listener to collection so UI updates realtime
  const { db, collection, onSnapshot } = firebaseExports;
  if(firestoreUnsub) firestoreUnsub(); firestoreUnsub = null;
  const coll = collection(db, `users/${currentUser.uid}/days/${currentDate}/activities`);
  firestoreUnsub = onSnapshot(coll, snap => {
    const arr = [];
    snap.forEach(d => arr.push({ id: d.id, ...d.data() }));
    activities = arr;
    renderList();
  }, err => {
    console.error('snapshot err', err);
  });
}

// ========== UI logic ==========
dateInput.value = todayISO();
currentDate = dateInput.value;
displayDateEl.textContent = currentDate;

dateInput.addEventListener('change', ()=>{
  currentDate = dateInput.value;
  displayDateEl.textContent = currentDate;
  loadActivitiesForCurrentDate();
});

async function loadActivitiesForCurrentDate(){
  if(usingFirebase && currentUser){
    // startFirestore listener will update UI via onSnapshot
    startListeningFirestore();
    // also get initial list once
    activities = await firestoreLoadActivities(currentUser.uid, currentDate);
    renderList();
  } else {
    // demo mode
    if(!currentUser) setupDemoAuth();
    activities = demoLoadActivities(currentUser.uid, currentDate);
    renderList();
  }
}

function renderList(){
  listEl.innerHTML = '';
  if(!activities || activities.length === 0){
    noDataEl.style.display = 'block';
    totalEl.textContent = '0';
    remainingEl.textContent = 'Remaining: 1440 min';
    analyseBtn.disabled = true;
    return;
  }
  noDataEl.style.display = 'none';
  let total = 0;
  // sort by title
  activities.sort((a,b)=> (a.title||'').localeCompare(b.title||''));
  activities.forEach(a=>{
    total += Number(a.minutes || 0);
    const node = document.createElement('div');
    node.className = 'activity';
    node.innerHTML = `
      <div>
        <div style="font-weight:700">${escapeHtml(a.title)}</div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
          <div class="small" style="padding:6px 8px;border-radius:8px;background:#fafafa">${escapeHtml(a.category)}</div>
          <div class="small">${a.minutes} min</div>
        </div>
      </div>
      <div style="display:flex;gap:6px">
        <button data-id="${a.id}" class="ghost btn-edit">Edit</button>
        <button data-id="${a.id}" class="ghost btn-del">Delete</button>
      </div>
    `;
    listEl.appendChild(node);
  });
  totalEl.textContent = total;
  remainingEl.textContent = `Remaining: ${Math.max(0,1440 - total)} min`;
  analyseBtn.disabled = (total !== 1440);

  // wire buttons
  listEl.querySelectorAll('.btn-del').forEach(b=>{
    b.onclick = async ()=> {
      const id = b.getAttribute('data-id');
      if(!confirm('Delete this activity?')) return;
      if(usingFirebase && currentUser){
        await firestoreDeleteActivity(currentUser.uid, currentDate, id);
      } else {
        activities = activities.filter(x=>x.id !== id);
        demoSaveActivities(currentUser.uid, currentDate, activities);
        renderList();
      }
    };
  });
  listEl.querySelectorAll('.btn-edit').forEach(b=>{
    b.onclick = async ()=> {
      const id = b.getAttribute('data-id');
      const a = activities.find(x=>x.id===id);
      if(!a) return;
      const newTitle = prompt('Title:', a.title);
      if(newTitle === null) return;
      const newCat = prompt('Category:', a.category);
      if(newCat === null) return;
      const newMinStr = prompt('Minutes:', a.minutes);
      if(newMinStr === null) return;
      const newMin = Number(newMinStr);
      if(isNaN(newMin) || newMin <= 0){ show('Invalid minutes'); return; }
      // check totals
      const totalNow = activities.reduce((s,x)=>s + Number(x.minutes||0), 0);
      const newTotal = totalNow - Number(a.minutes||0) + newMin;
      if(newTotal > 1440){ show(`Update would exceed 1440 minutes. You have ${1440 - (totalNow - Number(a.minutes||0))} minutes left.`); return; }
      if(usingFirebase && currentUser){
        await firestoreUpdateActivity(currentUser.uid, currentDate, id, { title:newTitle.trim(), category:newCat.trim(), minutes:newMin });
      } else {
        a.title = newTitle.trim(); a.category = newCat.trim(); a.minutes = newMin;
        demoSaveActivities(currentUser.uid, currentDate, activities);
        renderList();
      }
    };
  });
}

// add activity handler
addBtn.onclick = async ()=>{
  if(!currentDate){ show('Pick a date.'); return; }
  if(!currentUser) setupDemoAuth();
  const title = titleInput.value.trim();
  const category = categoryInput.value;
  const minutes = Number(minutesInput.value);
  if(!title || !minutes || minutes <= 0){ show('Enter valid title and minutes'); return; }
  const totalNow = activities.reduce((s,a)=>s + Number(a.minutes||0), 0);
  if(totalNow + minutes > 1440){ show(`Cannot add. You have ${1440 - totalNow} minutes left.`); return; }
  const activity = { title, category, minutes };
  if(usingFirebase && currentUser){
    // add to firestore
    await firestoreAddActivity(currentUser.uid, currentDate, activity);
    // Firestore snapshot will update UI
  } else {
    activity.id = genId();
    activities.push(activity);
    demoSaveActivities(currentUser.uid, currentDate, activities);
    renderList();
  }
  // clear inputs
  titleInput.value = ''; minutesInput.value = '';
};

// clear handler
clearBtn.onclick = ()=>{ titleInput.value=''; minutesInput.value=''; categoryInput.value='Work'; };

// seed demo data
seedBtn.onclick = ()=>{
  if(!currentUser) setupDemoAuth();
  const samples = [
    { title:'Sleep', category:'Sleep', minutes:480 },
    { title:'Work', category:'Work', minutes:480 },
    { title:'Study', category:'Study', minutes:180 },
    { title:'Exercise', category:'Exercise', minutes:60 },
    { title:'Entertainment', category:'Entertainment', minutes:120 },
    { title:'Misc', category:'Other', minutes:120 }
  ];
  // adjust date
  const arr = samples.map(s=> ({...s, id: genId()} ));
  if(usingFirebase && currentUser){
    (async ()=> {
      for(const a of arr){
        await firestoreAddActivity(currentUser.uid, currentDate, { title:a.title, category:a.category, minutes:a.minutes });
      }
      show('Seeded to Firestore.');
    })();
  } else {
    activities = arr;
    demoSaveActivities(currentUser.uid, currentDate, activities);
    renderList();
    show('Seeded demo data locally. You can now Analyse if total=1440.');
  }
};

// sign in button behavior
signInBtn.onclick = async ()=>{
  if(usingFirebase){
    // if firebase mode, call firebaseSignIn or signOut depending on currentUser
    if(currentUser && firebaseExports && firebaseExports.auth && firebaseExports.auth.currentUser){
      // sign out
      try{ await firebaseExports.signOut(firebaseExports.auth); } catch(e){ console.error(e) }
    } else {
      await firebaseSignIn();
    }
  } else {
    // demo sign-in toggles
    setupDemoAuth();
    signInBtn.textContent = 'Signed in (Demo)';
    show('Signed in as demo user. All actions are local.');
  }
};

// Analyse handler
analyseBtn.onclick = ()=>{
  if(!activities || activities.length === 0){ show('No data to analyse'); return; }
  // compute totals per category
  const map = {};
  activities.forEach(a => { map[a.category] = (map[a.category] || 0) + Number(a.minutes || 0); });
  const labels = Object.keys(map);
  const data = labels.map(l => map[l]);
  if(chartInstance) chartInstance.destroy();
  chartInstance = new Chart(chartCanvas, {
    type: 'pie',
    data: { labels, datasets: [{ data, backgroundColor: ['#FDE68A','#C7F9CC','#E9D5FF','#CFFAFE','#FFD7D2','#E8F0FF'] }] },
    options: { plugins:{legend:{position:'bottom'}} }
  });
  analyticsPanel.style.display = 'block';
  analyticsPanel.scrollIntoView({behavior:'smooth'});
};

closeChart.onclick = ()=>{
  analyticsPanel.style.display = 'none';
  if(chartInstance) chartInstance.destroy();
};

// load initial
(async ()=> {
  await initBackend();
  // default date
  dateInput.value = todayISO();
  currentDate = dateInput.value;
  displayDateEl.textContent = currentDate;
  // in firebase mode, signInBtn behavior will be set by auth listener
  if(!usingFirebase){
    signInBtn.textContent = 'Sign In (Demo)';
  } else {
    signInBtn.textContent = 'Sign In (Google)';
  }
  // initial load
  loadActivitiesForCurrentDate();
})();

// helper escape
function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;"); }
</script>
</body>
</html>
